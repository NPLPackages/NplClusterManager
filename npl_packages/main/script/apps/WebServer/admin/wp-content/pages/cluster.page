<?npl
--[[
Title: run any NPL code from web page
Author: LiXizhi
Date: 2015/6/23
Desc: 
- ajax/console?action=runcode&text=poststring&src=filename

Print all url params
- ajax/?action=getparams 

-- print request
- ajax/console?action=printrequest
]]

NPL.load("(gl)Mod/NplClusterManager/LocalResourceInfo.lua");
local LocalResourceInfo = commonlib.gettable("Mod.NplClusterManager.LocalResourceInfo");

NPL.load("(gl)script/ide/System/Database/TableDatabase.lua");
local TableDatabase = commonlib.gettable("System.Database.TableDatabase");
local db = TableDatabase:new():connect("temp/mydatabase/", function() end);

local NodeList = {};
local newIP = request:get("text");
local function getNewIP()
	return newIP or "";
end

local function getNodeList(re)
	db.Node:find({ip="127.0.0.1",}, function(err, rows) 
		re = rows;
		echo(rows);
	end);
	return re;
end

if(is_ajax()) then
	add_action('wp_ajax_cluster_get_nodelist', function()
		LOG.std(nil, "info", "clusrter", "cluster get nodelist");
		db:EnableSyncMode(true);
		local err, rows = db.Node:find({});
		echo(err);
		echo(rows);
		wp_send_json({result = rows}, true);
	end)

	add_action('wp_ajax_cluster_addnode', function()
		LOG.std(nil, "info", "clusrter", "cluster add node");
		db.Node:find({ip=newIP,}, function(err, rows)
			if(#rows == 0) then 
				db.Node:insertOne(nil, {ip=newIP,}, function(err, data)
					if(#data ~= 0) then 
						echo("节点添加成功");
						wp_send_json({result = "节点添加成功"}, true);
					else
						echo("节点添加失败，请确认后重试");
						wp_send_json({result = "节点添加失败，请确认后重试"}, true);
					end
				end);
			else
				echo("该节点已存在");
				wp_send_json({result = "该节点已存在"}, true);
			end
		end)

		db:EnableSyncMode(true);
		local err, rows = db.Node:find({ip=newIP});
		if(#rows) then 

    end)

	add_action('wp_ajax_cluster_getres', function()
		
	end)

	return;
end

?>




<?npl
wp_enqueue_script("ace", "/wp-includes/js/ace/ace.js"); 
wp_enqueue_script("angular", "/wp-includes/js/angular/angular.min.js");
wp_enqueue_script("ui.bootstrap",				"/wp-includes/js/angular/ui-bootstrap-tpls-1.3.3.min.js");
wp_enqueue_script("ngStorage", "/wp-includes/js/angular/ngStorage.js");
wp_enqueue_script("ngSanitize", "/wp-includes/js/angular/angular-sanitize.min.js");

wp_enqueue_script("ClusterManager_App",			"/wp-content/pages/cluster/app.js");
wp_enqueue_script("ClusterManagerController",		"/wp-content/pages/cluster/controllers/ClusterManagerController.js");

LOG.std(nil, "info", "cluster main", "cluster page init");
?>



<div class="title">NPL Cluster Manager</div>
<div ng-app="ClusterManager_App">
	<cluster-main></cluster-main>
</div>
